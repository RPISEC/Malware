#### Malware Analysis - Fall 2015
#### Lab 04 Solution

##### Lab_04-1.malware

This sample was first statically analyzed with IDA to determine what calls to look at. It was then run in a VM with no ASLR with break points at the interesting calls, and ran with these break points to see what happened.
    
1. Its calling KERNEL32!GetProcAddress for VirtualAlloc
2. Its calling VirtualAlloc to allocate 0xB000 bytes at 0x0C000000 as PAGE_EXECUTE_READWRITE
3. 0x401360 calls KERNEL32!GetProcAddress, 0x40137e also calls KERNEL32!GetProcAddress, but with advapi32.dll, and 0x401388 uses user32.dll.
4. GetModuleFileNameA,ExitProcess,CopyFileA,GetWindowsDirectoryA,LoadLibraryA,RegCreateKeyA,RegSetKeyValueA,RegCloseKey,MessageBoxA,
5. I set break points on the functions calling getProcAddress and looked at the arguments that were being passed.
6. Copies itself to C:\\WINDOWS\\virus.exe and then sets a registry key to auto run itself:
   ```C
   RegCreateKeyA("Software\\Microsoft\\Windows\\CurrentVersion\\Run");
   RegSetKeyValueA("viri","C:\\WINDOWS\\virus.exe");
   ```
   
   It then creates a message box saying "Infected!". After that it exits.
